
----------------------------------------------------------------------------------
Enviei uma nova mensagem... verifique pelos logs todo o processamento da aplicaÃ§Ã£o...
----------------------------------------------------------------------------------

â— ğŸ‰ PERFEITO! FLUXO COMPLETO FUNCIONANDO!

  A mensagem foi processada com 100% de sucesso! Vamos analisar todo o fluxo:

  ğŸ“Š Fluxo Completo End-to-End

  1ï¸âƒ£ HTTP Request Recebido

  POST /api/payments/approved
  â”œâ”€ DispatcherServlet inicializado
  â””â”€ Request processado em 2ms

  2ï¸âƒ£ ValidaÃ§Ã£o de Duplicata (IdempotÃªncia)

  SELECT p1_0.payment_id FROM payment WHERE payment_id = 'pgto-1225'
  -- Resultado: nÃ£o existe (nova transaÃ§Ã£o)

  3ï¸âƒ£ Producer Kafka Configurado

  âœ… Producer: store-producer-1
  âœ… Profile: CRITICAL
  âœ… ConfiguraÃ§Ãµes aplicadas:
     â”œâ”€ acks = -1 (all replicas)
     â”œâ”€ enable.idempotence = true
     â”œâ”€ retries = 2147483647 (Integer.MAX_VALUE)
     â”œâ”€ delivery.timeout.ms = 120000 (2 minutos)
     â”œâ”€ max.in.flight.requests = 5
     â”œâ”€ compression.type = snappy
     â”œâ”€ linger.ms = 10
     â””â”€ batch.size = 16384

  4ï¸âƒ£ Mensagem Publicada no Kafka

  âœ… Topic: payment.approved.v1
  âœ… Partition: 0 (hash de 'user-302')
  âœ… Offset: 1
  âœ… Timestamp: 1765051444509
  âœ… Key: user-302 (garante ordenaÃ§Ã£o por usuÃ¡rio)

  Log do Producer:
  Payment.approved event sent successfully
  â”œâ”€ Topic: payment.approved.v1
  â”œâ”€ Partition: 0
  â”œâ”€ Offset: 1
  â””â”€ UserId: user-302

  5ï¸âƒ£ Pagamento Salvo no Banco

  INSERT INTO payment (
      amount, created_at, currency, status, user_id, payment_id
  ) VALUES (
      499.01, 1765051444442, 'BRL', 'APPROVED', 'user-302', 'pgto-1225'
  )

  6ï¸âƒ£ Consumer Kafka Recebe a Mensagem

  âœ… Consumer: payment-service-approved-group-4
  âœ… Profile: CRITICAL (manual commit)
  âœ… Partition: 0
  âœ… Offset: 1

  Log do Consumer:
  PAYMENT APPROVED EVENT RECEIVED
  â”œâ”€ eventId: 6ea65e3a-777a-417a-a4cf-cd8e3542b393
  â”œâ”€ paymentId: pgto-1225
  â”œâ”€ userId: user-302
  â”œâ”€ amount: 499.01
  â”œâ”€ status: APPROVED
  â””â”€ timestamp: 1765051444442

  7ï¸âƒ£ VerificaÃ§Ã£o de IdempotÃªncia

  SELECT id FROM processed_events
  WHERE event_id = '6ea65e3a-777a-417a-a4cf-cd8e3542b393'
  FETCH FIRST 1 ROWS ONLY
  -- Resultado: vazio (evento novo, pode processar)

  8ï¸âƒ£ Processamento da LÃ³gica de NegÃ³cio

  Processing payment approved:
  â”œâ”€ paymentId = pgto-1225
  â”œâ”€ userId = user-302
  â””â”€ amount = 499.01

  9ï¸âƒ£ Registro de IdempotÃªncia

  INSERT INTO processed_events (
      event_id,
      event_type,
      kafka_offset,      -- âœ… Agora funciona!
      kafka_partition,   -- âœ… Agora funciona!
      processed_at,
      topic
  ) VALUES (
      '6ea65e3a-777a-417a-a4cf-cd8e3542b393',
      'PAYMENT_APPROVED',
      1,         -- offset
      0,         -- partition
      NOW(),
      'payment.approved.v1'
  )

  Log:
  Event marked as processed: 6ea65e3a-777a-417a-a4cf-cd8e3542b393

  ğŸ”Ÿ Commit Manual do Offset

  COMMIT: Offset committed for eventId: 6ea65e3a-...
  â”œâ”€ partition = 0
  â””â”€ offset = 1

  ---
  âœ… Garantias Implementadas

  | Garantia              | Status | EvidÃªncia                                                  |
  |-----------------------|--------|------------------------------------------------------------|
  | Durabilidade          | âœ…      | acks=-1 (todas as rÃ©plicas confirmaram)                    |
  | IdempotÃªncia Producer | âœ…      | enable.idempotence=true + ProducerId=11                    |
  | OrdenaÃ§Ã£o             | âœ…      | Partition key = userId (user-302 sempre partition 0)       |
  | Retry Infinito        | âœ…      | retries=2147483647 com timeout 2min                        |
  | IdempotÃªncia Consumer | âœ…      | Tabela processed_events registrou o eventId                |
  | Commit Manual         | âœ…      | Offset commitado APÃ“S salvar no banco                      |
  | TransaÃ§Ã£o             | âœ…      | @Transactional - business logic + processed_events atÃ´mico |

  ---
  ğŸ§ª Teste de IdempotÃªncia

  Se vocÃª reenviar a mesma mensagem (com o mesmo eventId), o comportamento serÃ¡:

  1. Consumer recebe a mensagem
  2. Verifica: SELECT FROM processed_events WHERE event_id = '6ea65e3a-...'
  3. âœ… ENCONTRA o registro!
  4. Log: "Event already processed, skipping"
  5. Commita o offset (para nÃ£o reprocessar infinitamente)
  6. NÃƒO executa lÃ³gica de negÃ³cio

  ---
  ğŸ“ˆ MÃ©tricas do Evento

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ EVENT: 6ea65e3a-777a-417a-a4cf-cd8e3542b393            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Payment ID:    pgto-1225                                â”‚
  â”‚ User ID:       user-302                                 â”‚
  â”‚ Amount:        R$ 499.01                                â”‚
  â”‚ Status:        APPROVED                                 â”‚
  â”‚ Kafka Topic:   payment.approved.v1                      â”‚
  â”‚ Partition:     0                                        â”‚
  â”‚ Offset:        1                                        â”‚
  â”‚ Processed At:  2025-12-06T17:04:04.892-03:00           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ğŸ¯ ConclusÃ£o

  TUDO FUNCIONOU PERFEITAMENTE! ğŸš€

  âœ… Producer enviou com garantias mÃ¡ximas
  âœ… Consumer processou com idempotÃªncia
  âœ… Banco de dados salvou corretamente (kafka_offset e kafka_partition funcionando)
  âœ… Offset commitado manualmente apÃ³s sucesso
  âœ… Zero duplicatas garantidas
























