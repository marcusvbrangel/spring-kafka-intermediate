
ğŸ” ExplicaÃ§Ã£o Completa dos Dois IDs

  Fluxo Passo-a-Passo:

  1. POST /api/payments/approved com payload: {"paymentId": "pgto-12", "userId": "user-84", ...}
     â†“
  2. ApprovePaymentService.approvePayment() - linha 93-101
     â†“
     Cria PaymentApprovedEvent com:
     eventId = UUID.randomUUID().toString()  â†’ bad5230c-6db5-4027-852e-6938e560630f
     paymentId = "pgto-12"
     userId = "user-84"
     ...
     â†“
  3. OutboxService.saveEvent() - linha 64-71
     â†“
     Cria OutboxEvent com:
     id = UUID.randomUUID().toString()  â†’ 411eeedf-89b4-4f19-b0a1-f71288809f31
     payload = JSON do PaymentApprovedEvent (inclui o eventId bad5230c...)
     â†“
  4. Salva na tabela outbox_event
     â†“
  5. OutboxPublisher (job a cada 5s) lÃª o OutboxEvent
     â†“
     Log no ms-producer: "Publishing outbox event: id=411eeedf-..." â† ID da tabela
     â†“
  6. Deserializa o payload JSON â†’ PaymentApprovedEvent
     â†“
     Evento recriado tem eventId = bad5230c-... (vem do JSON)
     â†“
  7. Publica no Kafka â†’ mensagem contÃ©m PaymentApprovedEvent
     â†“
  8. Consumer recebe PaymentApprovedEvent
     â†“
     Log no ms-consumer: "eventId=bad5230c-..." â† ID do evento de domÃ­nio
     â†“
  9. Salva na tabela processed_events usando eventId = bad5230c-...

  ğŸ“Š Tabela Comparativa

  | CaracterÃ­stica | OutboxEvent.id                       | PaymentApprovedEvent.eventId                 |
  |----------------|--------------------------------------|----------------------------------------------|
  | Gerado em      | OutboxEvent:95 (construtor)          | ApprovePaymentService:94                     |
  | Exemplo        | 411eeedf-89b4-4f19-b0a1-f71288809f31 | bad5230c-6db5-4027-852e-6938e560630f         |
  | Tabela         | outbox_event.id (PK)                 | processed_events.event_id (UNIQUE)           |
  | PropÃ³sito      | Rastrear registro outbox             | Garantir idempotÃªncia no consumer            |
  | VisÃ­vel em     | Logs do ms-producer                  | Logs do ms-consumer, Redpanda, Kafka headers |
  | Ciclo de vida  | Permanece no producer                | Viaja pelo Kafka atÃ© o consumer              |

  âœ… Por Que Dois IDs?

  Design Pattern correto! Cada ID tem uma responsabilidade:

  OutboxEvent.id (ID de infraestrutura)

  - Identifica o registro na tabela outbox
  - Usado para controle interno do padrÃ£o Outbox
  - Permite rastrear status (PENDING â†’ PUBLISHED)
  - Permite retry e recuperaÃ§Ã£o de falhas no publisher
  - Escopo: Apenas ms-producer

  PaymentApprovedEvent.eventId (ID de domÃ­nio)

  - Identifica o evento de negÃ³cio end-to-end
  - Usado para idempotÃªncia no consumer
  - Garante que o mesmo evento nÃ£o seja processado 2x
  - Escopo: Producer â†’ Kafka â†’ Consumer (viaja por todo o fluxo)

