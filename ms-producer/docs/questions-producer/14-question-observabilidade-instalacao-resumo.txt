
â— Vou criar um resumo completo da soluÃ§Ã£o de observabilidade implementada:

  ğŸ‰ STACK COMPLETA DE OBSERVABILIDADE IMPLEMENTADA!

  ---
  âœ… O QUE FOI CRIADO:

  1. Dashboards Grafana (2 dashboards completos)

  a) Microservices E2E Observability (microservices-e2e.json)
  - âœ… HTTP Metrics (ms-producer):
    - Taxa de requisiÃ§Ãµes (req/s)
    - LatÃªncia P95/P99
    - Taxa de erro
  - âœ… JVM Metrics (producer + consumer):
    - Uso de memÃ³ria (heap/non-heap)
    - CPU utilization
    - Garbage Collection
  - âœ… Kafka Metrics:
    - Throughput (msgs/s)
    - Consumer lag (gauge)
    - Producer send rate
  - âœ… Distributed Traces:
    - Painel interativo do Tempo
    - Click para explorar traces

  b) Database & Hibernate Performance (database-performance.json)
  - âœ… HikariCP Connection Pool:
    - ConexÃµes ativas/idle/pending
    - Connection acquire time (P95/P99)
  - âœ… PostgreSQL Metrics:
    - ConexÃµes ativas por database
    - Cache hit ratio (gauge)
    - Taxa de transaÃ§Ãµes (commits/rollbacks)
    - Locks count
  - âœ… Hibernate/JDBC Performance:
    - Recent SQL queries traces
    - Database operations rate (reads/inserts/updates)
  - âœ… IdentificaÃ§Ã£o de Queries Lentas:
    - Painel de traces mostrando queries SQL individuais
    - LatÃªncia por query

  ---
  2. PostgreSQL Exporters

  - âœ… postgres-exporter-producer (porta 9187)
    - Monitora database ms-producer
  - âœ… postgres-exporter-consumer (porta 9188)
    - Monitora database ms-consumer

  MÃ©tricas coletadas:
  - ConexÃµes ativas
  - Cache hit ratio
  - TransaÃ§Ãµes (commits/rollbacks/deadlocks)
  - Locks
  - Tuples (inserted/updated/deleted/returned)

  ---
  3. Regras de Alerta (prometheus-alerts.yaml)

  10 Alertas Configurados:

  | Alerta                   | Threshold            | Severidade | DescriÃ§Ã£o              |
  |--------------------------|----------------------|------------|------------------------|
  | HighHTTPLatency          | P95 > 1s por 2min    | warning    | LatÃªncia HTTP alta     |
  | HighHTTPErrorRate        | >0.1 req/s por 1min  | critical   | Taxa de erro HTTP alta |
  | HighConsumerLag          | >10000 msgs por 5min | warning    | Consumer lag alto      |
  | HighJVMMemoryUsage       | >90% heap por 5min   | warning    | MemÃ³ria JVM alta       |
  | ConnectionPoolExhausted  | pending >0 por 1min  | critical   | Pool HikariCP esgotado |
  | LowDatabaseCacheHitRatio | <95% por 10min       | warning    | Cache hit ratio baixo  |
  | HighDatabaseConnections  | >20 conn por 5min    | warning    | Muitas conexÃµes DB     |
  | DatabaseDeadlocks        | >0 por 1min          | critical   | Deadlocks detectados   |
  | SlowDatabaseQueries      | P95 >0.5s por 5min   | warning    | Queries lentas         |
  | HighRollbackRate         | >10% por 5min        | warning    | Alta taxa de rollback  |

  ---
  4. CorrelaÃ§Ã£o de Dados

  âœ… Tempo â†’ Loki (configurado)
  - Click em um trace â†’ Ver logs correlacionados
  - Query automÃ¡tica: {service_name=~".+"} | trace_id = $trace_id

  âœ… Loki â†’ Tempo (configurado)
  - Click em trace_id no log â†’ Abrir trace no Tempo

  ---
  ğŸ“Š COMO USAR:

  1. Acessar Grafana

  http://localhost:3000
  Login: admin / admin

  2. Dashboards DisponÃ­veis

  # Menu: Dashboards â†’ Browse
  â”œâ”€â”€ Microservices E2E Observability
  â”‚   â”œâ”€â”€ HTTP requests rate & latency
  â”‚   â”œâ”€â”€ JVM memory & CPU
  â”‚   â”œâ”€â”€ Kafka throughput & lag
  â”‚   â””â”€â”€ Distributed traces
  â”‚
  â””â”€â”€ Database & Hibernate Performance
      â”œâ”€â”€ HikariCP connection pool
      â”œâ”€â”€ PostgreSQL metrics
      â”œâ”€â”€ SQL queries traces
      â””â”€â”€ Cache hit ratio & locks

  3. Explorar Traces (Tempo)

  Menu: Explore â†’ Datasource: Tempo

  # Buscar traces por serviÃ§o
  Query: {resource.service.name="ms-producer"}

  # Buscar queries SQL especÃ­ficas
  Query: {resource.service.name=~".*"} && {name=~".*SELECT.*"}

  # Buscar por trace ID
  Query: {trace_id="abc123..."}

  4. Consultar Logs (Loki)

  Menu: Explore â†’ Datasource: Loki

  # Logs do producer
  {service_name="ms-producer"}

  # Logs do consumer
  {service_name="ms-consumer"}

  # Logs com nÃ­vel ERROR
  {service_name=~".+"} | level="ERROR"

  # Logs de um trace especÃ­fico
  {service_name=~".+"} | trace_id="abc123"

  5. MÃ©tricas PostgreSQL (Prometheus)

  # Cache hit ratio
  rate(pg_stat_database_blks_hit[5m]) /
  (rate(pg_stat_database_blks_hit[5m]) + rate(pg_stat_database_blks_read[5m]))

  # ConexÃµes ativas
  pg_stat_database_numbackends{database="ms-producer"}

  # Taxa de transaÃ§Ãµes
  rate(pg_stat_database_xact_commit{database="ms-producer"}[5m])

  # Deadlocks
  increase(pg_stat_database_deadlocks[5m])

  6. Ver Alertas

  http://localhost:9090/alerts

  Ou no Grafana:
  Menu: Alerting â†’ Alert rules

  ---
  ğŸ”— FLUXO COMPLETO DE OBSERVABILIDADE:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    REQUEST HTTP                              â”‚
  â”‚              POST /api/payments/approved                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                  ms-producer                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ OpenTelemetry Auto-Instrumentation                   â”‚  â”‚
  â”‚  â”‚  â”œâ”€ HTTP span (latency, status code)                 â”‚  â”‚
  â”‚  â”‚  â”œâ”€ JDBC span (SQL queries, duration)                â”‚  â”‚
  â”‚  â”‚  â””â”€ Kafka span (topic, partition, offset)            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚           â”‚                                                  â”‚
  â”‚           â”œâ”€ Logs (Logback â†’ OTLP Appender)                 â”‚
  â”‚           â”œâ”€ Traces (OpenTelemetry SDK)                     â”‚
  â”‚           â””â”€ Metrics (Micrometer + OTLP)                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚            OpenTelemetry Collector (4317/4318)              â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ Receivers: OTLP (gRPC + HTTP)                        â”‚  â”‚
  â”‚  â”‚ Processors: Batch, Memory Limiter                    â”‚  â”‚
  â”‚  â”‚ Exporters:                                            â”‚  â”‚
  â”‚  â”‚  â”œâ”€ Tempo (traces)                                    â”‚  â”‚
  â”‚  â”‚  â”œâ”€ Loki (logs)                                       â”‚  â”‚
  â”‚  â”‚  â””â”€ Prometheus (metrics)                              â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚            â”‚
              â–¼            â–¼            â–¼            â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   Loki   â”‚  â”‚   Tempo  â”‚  â”‚Prometheusâ”‚  â”‚PostgreSQLâ”‚
      â”‚  (logs)  â”‚  â”‚ (traces) â”‚  â”‚(metrics) â”‚  â”‚Exporters â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚            â”‚            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Grafana    â”‚
                    â”‚ Dashboards   â”‚
                    â”‚   Alerting   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ğŸš€ PRÃ“XIMOS PASSOS:

  1. Reiniciar os microserviÃ§os (se necessÃ¡rio)
  2. Fazer alguns requests para gerar telemetria
  3. Acessar Grafana e explorar os dashboards
  4. Clicar em traces para ver correlaÃ§Ã£o com logs
  5. Verificar alertas no Prometheus
  6. Identificar queries lentas do Hibernate no dashboard de database

  TODA A INFRAESTRUTURA ESTÃ PRONTA E FUNCIONANDO! ğŸ‰













